#!/bin/bash

export HOME_PATH=`pwd`
export GLOBUS_LOCATION=${HOME_PATH}
export GLOBUS_PATH=${GLOBUS_LOCATION}
export LD_LIBRARY_PATH=${GLOBUS_LOCATION}/lib

export PATH=${GLOBUS_LOCATION}:${PATH}

#export JAVA_HOME=/home/iraicu/jdk1.6.0
#export PATH=${JAVA_HOME}:${JAVA_HOME}/bin:${PATH}


source ${GLOBUS_LOCATION}/etc/globus-devel-env.sh

#AstroPortal specific things...
export FUN_TOOLS=${HOME_PATH}/funtools-1.3.0b21



#To compile the C++ and JNI funsky
echo "cleaning up funsky files..."
rm JNI/FunTools/*.so 
rm JNI/FunTools/*.class
rm JNI/FunTools/*.h
rm ${LD_LIBRARY_PATH}/*.so
rm -rf JNI_FunTools.jar
rm -rf ${LD_LIBRARY_PATH}/JNI_FunTools.jar

echo "compiling the funsky java interface..."
javac JNI/FunTools/funsky_JNI.java
javah -d JNI/FunTools/ -jni JNI.FunTools.funsky_JNI
echo "compiling the funsky C++ code..."
g++ -shared -static -I${FUN_TOOLS} -I${FUN_TOOLS}/util -I${FUN_TOOLS}/fitsy -I${FUN_TOOLS}/wcs -I${FUN_TOOLS}/filter JNI/FunTools/funsky-so.c -o JNI/FunTools/libfunsky.so JNI/FunTools/libfuntools.a -lm -lpthread
cp JNI/FunTools/libfunsky.so ${LD_LIBRARY_PATH}/

echo "creating JAR file of funsky and updating the library path..."
jar cf JNI_FunTools.jar JNI
mv JNI_FunTools.jar ${LD_LIBRARY_PATH}
                         
#update the stubs
#echo "recompile stubs..."
#./make.stubs.sh
echo "update the stubs..."
cp ../service/org_globus_GenericPortal_common.jar .
cp -r ../service/build/schema .
cp -r ../service/build/stubs/classes/org/globus/GenericPortal/stubs org/globus/GenericPortal/
cp -r ../service/org .


#To compile common stuff
echo "compile common stuff"
javac org/globus/GenericPortal/common/*.java
rm -rf org_globus_GenericPortal_common.jar
rm -rf ${GLOBUS_LOCATION}/lib/org_globus_GenericPortal_common.jar
jar cf org_globus_GenericPortal_common.jar org/globus/GenericPortal/common/*.class
cp org_globus_GenericPortal_common.jar ${GLOBUS_LOCATION}/lib/

echo "Compiling ClientCreate.java"
javac -classpath $CLASSPATH:. org/globus/GenericPortal/clients/FactoryService_GP/ClientCreate.java
echo "Compiling ImageStacking.java"
javac -classpath $CLASSPATH:. org/globus/GenericPortal/clients/GPService_instance/ImageStacking.java
echo "Compiling ImageStackingMain.java"
javac -classpath $CLASSPATH:. org/globus/GenericPortal/clients/GPService_instance/ImageStackingMain.java
echo "Compiling WorkerRun.java"
javac -classpath $CLASSPATH:. org/globus/GenericPortal/clients/GPService_instance/WorkerRun.java
echo "Compiling WorkerRunGram.java"
javac -classpath $CLASSPATH:. org/globus/GenericPortal/clients/GPService_instance/WorkerRunGram.java

echo "Compiling GramClient"
javac org/globus/GenericPortal/common/GramClient.java


